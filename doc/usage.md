# Usage of ease tool

**Note:** Version 5.X of `ffmpeg` and `ffprobe` binaries (built with `libvmaf`) are
required to be available in `$PATH` for video quality calculations.

For full and up-to-date usage examples and documentation of options consult
`ease` tool help with `ease -h`.

Tool consists of a number of subcommands, at this point following subcommands are
implemented:

- `ease encode`
- `ease analyse`
- `ease bitrate`
- `ease vqmplot`

## Intended usage workflow

Usual workflow consists of a number of logical stages:

- [Encoding plan](#encoding-plan) preparation: this defines what to encoded (your mezzanine clips) and how
  to encode (encoder string/scheme/command-line). Think of this as sort of declarative
  approach to defining batch-encode commands.

- Running [encoding stage](#encoding-stage): based on what is defined in encoding plan - perform encoding
  according to defined encoding scheme, save compressed outputs, run VMAF calculations  and
  save results.

- Running [analysis stage](#analysis-stage): prepare charts and graphs with bitrate plots, VQ metrics such as
  VMAF, PSNR etc.

All above from can be achieved with following `ease` tool commands:

```
$ ease encode -plan encoding_plan.json -report run_report.json
$ ease analyse -report run_report.json -out-dir analysis
```

## Encoding stage

Example of a simple batch encoding stage looks like:

```
$ ease encode -plan encoding_plan.json -report run_report.json
```

Where `encoding_plan.json` defines all encoder runs - essentially an batch
encode configuration and `run_report.json` contains encoding run metadata and
per encoding results.

Full list of options are as follows (from `ease encode -h`):

>  -plan string
>
>    	Encoding plan configuration file

Mandatory option. Path to "encoding plan" configuration file.

>  -report string
>
>    	Encoding plan report file (default is stdout)

Optional path to JSON report file.

>  -vqm
>
>    	Calculate VQMs (default true)

Controls if VQMs are calculated for this run. Since VQM calculation is CPU
intensive and time consuming - it is possible to disable VQM calculation via
`-vqm=false`. Default is to run VQM calculations for all encoded files. This
stage can be time consuming for long videos and/or on weak hardware.

>  -dry-run
>
>    	Do not actually run, just do checks and validation

Will perform a "dry run" of "encoding plan". Meaning will do validation of
configuration and other checks - no actual encodings will be performed.

## Encoding plan

Term "encoding plan" is used in this project to refer to a single event of batch
execution of encoding commands. The encoding plan is defined by a single
configuration file. At this point configuration is defined as a simple JSON
document. It is possible that some other format of configuration will be adopted
in future.

This is a simple example of encoding plan configuration in JSON:

```json
{
    "OutDir": "x264_out",
    "Inputs": [
        "./videos/clip01.mp4",
        "./videos/clip02.mp4"
    ],
    "Schemes": [
        {
            "Name": "tbr_1700k",
            "CommandTpl": [
                "ffmpeg -i %INPUT% ",
                "-c:v libx264 -an -f mp4 -g 25 -r 25 ",
                "-tune zerolatency -preset faster ",
                "-b:v 1700k -maxrate 2100k -bufsize 2100k ",
                "-y %OUTPUT%.mp4"
            ]
        },
        {
            "Name": "tbr_2000k",
            "CommandTpl": [
                "ffmpeg -i %INPUT% ",
                "-c:v libx264 -an -f mp4 -g 25 -r 25 ",
                "-tune zerolatency -preset faster ",
                "-b:v 2000k -maxrate 2500k -bufsize 2500k ",
                "-y %OUTPUT%.mp4"
            ]
        }
    ]
}
```

JSON configuration file consists of following:

- `OutDir` is directory in which to save encoded/compressed files and log output
  generated by encoder command.
- `Inputs` is an array of source/mezzanine video files that are subject to
  compression
- `Schemes` is an array that contains various encoder commands. This is
  basically a list of all encoder command lines that are part of this encoding
  plan and will be executed for each source video defined in `Inputs`.
- Scheme `Name` is a name for specific encoder command, this of it as some
  meaningful nomenclature for this specific encoding experiment. This name will
  be used in compressed file filename - so keep it sane.
- Scheme `CommandTpl` is a "template" for executing a specific encoding
  experiment. It is basically an encoder command-line with `%INPUT%` and
  `%OUTPUT%` placeholders.

  Also worth noting that `CommandTpl` is an array of strings, reason for this is
  to have ability to split long encoder command-lines into "multi-lines" thus
  making it easier on human eyes. Elements of array are joined together later on
  into single string, so keep this in ming and put trailing spaces where needed.

If we would execute this sample encoding plan with `ease` tool via:

```
$ ease encode -plan encoding_plan.json -report run_report.json
```

As a result we would get following file structure:

```
├── encoding_plan.json
├── run_report.json
├── videos
│   ├── clip01.mp4
│   └── clip02.mp4
└── x264_out
    ├── clip01_tbr_1700k.mp4
    ├── clip01_tbr_1700k.out
    ├── clip01_tbr_1700k_vqm.json
    ├── clip01_tbr_2000k.mp4
    ├── clip01_tbr_2000k.out
    ├── clip01_tbr_2000k_vqm.json
    ├── clip02_tbr_1700k.mp4
    ├── clip02_tbr_1700k.out
    ├── clip02_tbr_1700k_vqm.json
    ├── clip02_tbr_2000k.mp4
    ├── clip02_tbr_2000k.out
    └── clip02_tbr_2000k_vqm.json
```

Compressed clips `*.mp4` along with encoder generated log output `*.out` and libvmaf log
output `*.json` are saved into `x264_out/` directory as specified by `OutDir`
configuration option from encoding plan. Also, encoding run result is saved to
`run_report.json` as specified with `-report` command-line flag.

## Analysis stage

To aid in analysis part of encoded videos there is `ease analyse` subcommand.
This subcommand requires artifacts from previous encoding stage. For time being
input for `ease analyse` is encoding plan report generated by `ease encode`
tool.

Example usage:

```
ease analyse -report path/to/ease-encode-generated/report.json -out-dir analysis
```

Analysis artifacts will be placed in directory specified with option `-out-dir`.
These artifacts include:

- Bitrate plot (aggregated into 1s buckets) and frame size plot
- VMAF, PSNR and MS-SSIM metrics related plots (per-frame , histogram,
  Cumulative Distribution Function)

If we would continue with analysis stage where we left off in [Encoding plan](#encoding-plan) after running encoding stage:

```
$ ease analyse -report run_report.json -out-dir analysis
```

As a result we would get following charts and plots in `analysis` directory:

```
analysis/
├── clip01_tbr_1700k
│   ├── clip01_tbr_1700k_bitrate.png
│   ├── clip01_tbr_1700k_ms-ssim.png
│   ├── clip01_tbr_1700k_psnr.png
│   └── clip01_tbr_1700k_vmaf.png
├── clip01_tbr_2000k
│   ├── clip01_tbr_2000k_bitrate.png
│   ├── clip01_tbr_2000k_ms-ssim.png
│   ├── clip01_tbr_2000k_psnr.png
│   └── clip01_tbr_2000k_vmaf.png
├── clip02_tbr_1700k
│   ├── clip02_tbr_1700k_bitrate.png
│   ├── clip02_tbr_1700k_ms-ssim.png
│   ├── clip02_tbr_1700k_psnr.png
│   └── clip02_tbr_1700k_vmaf.png
└── clip02_tbr_2000k
    ├── clip02_tbr_2000k_bitrate.png
    ├── clip02_tbr_2000k_ms-ssim.png
    ├── clip02_tbr_2000k_psnr.png
    └── clip02_tbr_2000k_vmaf.png
```

## Other subcommands

For convenience purposes there are also 2 other subcommands - namely `bitrate`
and `vqmplot`, these will create bitrate plot for a given video file and create
VQM plot from *libvmaf* generated JSON report accordingly. Again, consult each
subcommand's help e.g. `ease bitrate -h` and `ease vqmplot -h` for full help.

Examples `bitrate` usage:

```
ease bitrate -i my_video.mpx -o by_video_bitrate.png
```

Examples `vqmplot` usage:

```
ease vqmplot -m PSNR -i libvmaf.json -o psnr.png
```
